---
layout: post
title: 又是race condition惹的祸
---
困扰了我几天的BUG，终于发现了。原来是有多个线程并发访问同一个socket连接对象，引起在发送文件时产生race condition。加了一个锁之后，问题迎刃而解。

其实早该想到这个可能。从看到代码是多线程时，我就想到了同步，但每次总没有细细地分析。直到今天早上一觉醒来，才蓦然想到。

VCL的ADO连接也不是线程安全的，大概因为它保存了内部状态的原因。所以以后要么用锁来保护这个连接，要么每个线程用一个连接，让数据库引擎来处理并发问题。我觉得还是后者好，让代码更简单，而且效率可能更高。因为数据库引擎自己的并发粒度，当然比自己lock的粒度要精细一些。

程序员，你必须具有数学家的耐心和推理能力。
