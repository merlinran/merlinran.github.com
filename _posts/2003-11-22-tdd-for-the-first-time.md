---
layout: default
title: 第一次实践测试驱动的开发
---
xiaoqi今天去南山玩的时候，我还在公司的电脑上飞快地敲打着键盘。从他打回来的电话中听得出他的喜悦之情。虽然没有佳人相伴，但久违了的冬日，已经够让人着迷了。
但我觉得自己和他一样兴奋。我在尝试用测试驱动的方法写一个小的通信客户端库，用Win32的异步选择模式。测试框架采用boost.test。
只有真正尝试，才能理解为何Martin Fowler事先要故意让测试失败。测试代码和设计，到底谁先谁后呢？我认为还是前者。如果我只是为了能够让测试通过，我完全可以把事件处理和通信放到一起，但我明白，这样会让真正的应用代码显得很丑陋，依赖关系很强。所以，我事先就已经决定要用一个Handler接口来让应用代码收取事件，用pimpl idiom来减小依赖。实际上，后来写测试时也验证了我这一点。如果没有Handler，我就没有办法从它派生一个Mock Object，进而测试事实上进行通信的那个类。
比如，我要测试连接，我可以连接到本机的ECHO服务端口，在MockHandler的OnConnect中设置一个标记，在测试代码中，先连接，等待一定的时间，再检查这个标记必须为真。发送和接收也一样，连接到ECHO服务端口，发送某个字符串，再验证收取的是否和发送的一样。
测试为何要事先写呢？因为此时，除了简要的设计之外，你对类的实现没有任何概念，此时写的测试，不会受到实现的干扰。此时也比较清醒，没有被代码所迷惑，可以列出一些边界情况，以尽可能多地去除BUG。
其实我做得还很不够。需要把测试优先的思想一直贯穿在自己写代码的始终。即使只有我一个人使用这样的方法，也并不会影响整个项目的进度。别人根本没有单元测试，我希望能以我的行动，让大家看到这样做的好处。前提是：我自己必须熟练地运用它。
